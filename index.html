<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --bg: var(--tg-theme-bg-color, #ffffff);
            --text: var(--tg-theme-text-color, #000000);
            --accent: var(--tg-theme-button-color, #007aff);
            --accent-text: var(--tg-theme-button-text-color, #ffffff);
            --secondary: var(--tg-theme-secondary-bg-color, #f2f2f7);
            --gray: #8e8e93;
            --card-bg: var(--tg-theme-secondary-bg-color, #f1f1f1);
            --gold: #f1c40f; 
        }

        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 100px; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        .header { padding: 20px 15px; font-size: 24px; font-weight: 800; }
        .page { display: none; padding: 0 15px; }
        .page.active { display: block; }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .card { background: var(--card-bg); border-radius: 18px; overflow: hidden; border: 0.5px solid rgba(128,128,128,0.2); display: flex; flex-direction: column; }
        .card img { width: 100%; height: 180px; object-fit: cover; cursor: pointer; background: #eee; }
        .card-label { padding: 10px; font-weight: 600; font-size: 14px; text-align: center; flex-grow: 1; }
        
        .buy-btn { background: var(--accent); color: var(--accent-text); border: none; padding: 12px; font-weight: bold; cursor: pointer; width: 100%; transition: opacity 0.2s; }
        .buy-btn:active { opacity: 0.7; }
        
        .btn-qty { background: var(--accent); color: var(--accent-text); border: none; width: 32px; height: 32px; border-radius: 8px; font-weight: bold; font-size: 18px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .btn-qty:disabled { opacity: 0.2; }
        
        .btn-qty-sm { background: var(--accent); color: var(--accent-text); border: none; width: 28px; height: 28px; border-radius: 6px; font-weight: bold; font-size: 16px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .btn-qty-sm:disabled { opacity: 0.2; }

        .row-item { background: var(--card-bg); padding: 15px; border-radius: 15px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; border: 0.5px solid rgba(128,128,128,0.1); }
        
        .item-info { flex: 1; padding-right: 10px; }
        .item-controls { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
        .qty-num { font-weight: bold; min-width: 24px; text-align: center; font-size: 16px; }
        .marker-qty { font-weight: bold; font-size: 14px; min-width: 18px; text-align: center; color: var(--accent); }

        .marker-num { font-weight: 800; font-size: 18px; color: var(--text); }
        .stock-badge { font-size: 13px; font-weight: bold; margin-top: 4px; display: block; }
        .category-title { margin: 20px 0 10px; font-size: 14px; color: var(--gray); text-transform: uppercase; font-weight: bold; }

        .nav { position: fixed; bottom: 0; width: 100%; height: 75px; background: var(--bg); display: flex; border-top: 0.5px solid rgba(128,128,128,0.3); z-index: 999; }
        .nav-btn { position: relative; flex: 1; border: none; background: none; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 11px; color: var(--gray); }
        .nav-btn.active { color: var(--accent); }
        .nav-icon { font-size: 22px; margin-bottom: 4px; }
        
        .badge { position: absolute; top: 5px; left: 55%; background: #ff3b30; color: white; border-radius: 10px; padding: 2px 7px; font-size: 11px; font-weight: bold; }

        .gold-book {
            color: var(--gold);
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }

        .balance-card {
            background: linear-gradient(135deg, #FF8C00 0%, #E65100 100%);
            border-radius: 20px; padding: 25px 20px; color: white; text-align: center;
            box-shadow: 0 10px 20px rgba(230, 81, 0, 0.3); margin-top: 10px;
        }
        .balance-amount { font-size: 48px; font-weight: 800; margin: 10px 0; display: flex; align-items: center; justify-content: center; gap: 15px; }
        .bonus-badge { color: white; font-weight: bold; margin-top: 5px; font-size: 14px; opacity: 0.9; }

        #viewer { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #000; z-index: 1000; }
        .viewer-header { padding: 15px; display: flex; justify-content: space-between; align-items: center; background: var(--bg); border-bottom: 0.5px solid rgba(128,128,128,0.2); }
        
        input { width: 100%; padding: 14px; border-radius: 12px; border: none; background: var(--secondary); color: var(--text); margin-bottom: 15px; box-sizing: border-box; outline: none; }
    </style>
</head>
<body>

    <div id="answers" class="page active">
        <div class="header">–û—Ç–≤–µ—Ç—ã</div>
        <input type="text" id="bookSearch" placeholder="–ü–æ–∏—Å–∫ —Ç–æ–º–∞..." oninput="filterBooks()">
        <div id="booksGrid" class="grid"></div>
    </div>

    <div id="palettes" class="page">
        <div class="header">–ü–∞–ª–∏—Ç—Ä—ã</div>
        <div class="category-title">GuangNa</div>
        <div class="row-item"><span>GuangNa 120</span><button class="buy-btn" style="width:auto; border-radius:8px; padding: 8px 15px;" onclick="tg.openLink('https://hachettelittleheroes.github.io/HachetteLittleHeroesBot/palitri/guangna120.pdf')">PDF</button></div>
        <div class="row-item"><span>GuangNa 168</span><button class="buy-btn" style="width:auto; border-radius:8px; padding: 8px 15px;" onclick="tg.openLink('https://hachettelittleheroes.github.io/HachetteLittleHeroesBot/palitri/guangna168.pdf')">PDF</button></div>
        <div class="row-item"><span>GuangNa 240</span><button class="buy-btn" style="width:auto; border-radius:8px; padding: 8px 15px;" onclick="tg.openLink('https://hachettelittleheroes.github.io/HachetteLittleHeroesBot/palitri/guangna240.pdf')">PDF</button></div>
        <div class="row-item"><span>GuangNa 360</span><button class="buy-btn" style="width:auto; border-radius:8px; padding: 8px 15px;" onclick="tg.openLink('https://hachettelittleheroes.github.io/HachetteLittleHeroesBot/palitri/guangna360.pdf')">PDF</button></div>
        <div class="category-title">–î—Ä—É–≥–∏–µ</div>
        <div class="row-item"><span>Tooli-Art</span><button class="buy-btn" style="width:auto; border-radius:8px; padding: 8px 15px;" onclick="tg.openLink('https://hachettelittleheroes.github.io/HachetteLittleHeroesBot/palitri/tooliart.pdf')">PDF</button></div>
        <div class="row-item"><span>Grasp 168</span><button class="buy-btn" style="width:auto; border-radius:8px; padding: 8px 15px;" onclick="tg.openLink('https://hachettelittleheroes.github.io/HachetteLittleHeroesBot/palitri/grasp168.pdf')">PDF</button></div>
        <div class="row-item"><span>Zibeef 240</span><button class="buy-btn" style="width:auto; border-radius:8px; padding: 8px 15px;" onclick="tg.openLink('https://hachettelittleheroes.github.io/HachetteLittleHeroesBot/palitri/zibeef240.pdf')">PDF</button></div>
    </div>

    <div id="shop" class="page">
        <div class="header">–ú–∞—Ä–∫–µ—Ä—ã</div>
        <div class="category-title" style="margin-top: 0; display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px;">
            <span>GuangNa</span>
            <span style="color: var(--accent); text-transform: none; font-size: 15px;">75 —Ä—É–±./—à—Ç.</span>
        </div>
        <input type="text" id="markerSearch" placeholder="–ü–æ–∏—Å–∫ –Ω–æ–º–µ—Ä–∞..." oninput="filterMarkers()">
        <div id="markersList"></div>
    </div>

    <div id="cart" class="page">
        <div class="header">–ö–æ—Ä–∑–∏–Ω–∞</div>
        <div id="cartList"></div>
        <button id="mainOrderBtn" class="buy-btn" style="border-radius: 15px; padding: 18px; margin-top:20px; display: none;" onclick="checkout()">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
    </div>

    <div id="profile" class="page">
        <div class="header">–ü—Ä–æ—Ñ–∏–ª—å</div>
        <div class="balance-card">
            <p style="margin:0; opacity:0.9; font-size: 14px; letter-spacing: 1px;">–í–ê–® –ë–ê–õ–ê–ù–°</p>
            <div class="balance-amount"><span id="userBalance">0</span> <i class="fas fa-book-open gold-book"></i></div>
            <p style="margin:0; font-weight: 500;">–∞—à–µ—Ç–∏–∫–æ–≤ –Ω–∞–∫–æ–ø–ª–µ–Ω–æ</p>
        </div>
        <div class="category-title" style="margin-top:25px;">–ü—Ä–æ–≥—Ä–∞–º–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏</div>
        <div class="row-item"><span>–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –±–æ–Ω—É—Å</span><b class="gold-book">+100 <i class="fas fa-book-open"></i></b></div>
        <div class="row-item"><span>–ë–æ–Ω—É—Å –∑–∞ –æ—Ç–∑—ã–≤</span><b class="gold-book">+25 <i class="fas fa-book-open"></i></b></div>
        <div class="row-item"><span>–ë–æ–Ω—É—Å –∑–∞ –ø–æ–∫—É–ø–∫—É –æ—Ç 3000‚ÇΩ</span><b class="gold-book">+20 <i class="fas fa-book-open"></i></b></div>
        <div class="row-item">
            <div style="display:flex; flex-direction:column;">
                <span>–ë–æ–Ω—É—Å—ã –∑–∞ –∫—Ä—É–ø–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏</span>
                <small style="color:var(--gray); font-size:11px;">–æ—Ç 5–∫ - 30 / –æ—Ç 7.5–∫ - 40 / –æ—Ç 10–∫ - 50</small>
            </div>
            <b class="gold-book"><i class="fas fa-book-open"></i></b>
        </div>
        <div class="row-item"><span>–°–æ–±—ã—Ç–∏–µ ¬´Baby Boom¬ª</span><b class="gold-book">+50 <i class="fas fa-book-open"></i></b></div>
        <div class="row-item"><span>1 –º–µ—Å—Ç–æ –≤ —á–µ–ª–ª–µ–Ω–¥–∂–∞—Ö</span><b class="gold-book">+150 <i class="fas fa-book-open"></i></b></div>
        <div style="font-size: 12px; color: var(--gray); padding: 10px;">ID: <span id="userIdDisplay">---</span></div>
    </div>

    <div id="viewer">
        <div class="viewer-header">
            <button class="buy-btn" style="width:auto; border-radius:8px; padding: 8px 15px;" onclick="closeBook()">–ù–∞–∑–∞–¥</button>
            <div id="page-counter" style="color:var(--text); font-weight:bold;"></div>
        </div>
        <div id="viewer-content" style="height: 85vh; display: flex; align-items: center; justify-content: center; overflow: hidden; touch-action: none;" ontouchstart="handleTouchStart(event)" ontouchend="handleTouchEnd(event)">
            <img src="" id="current-page" style="max-width: 100%; max-height: 100%; object-fit: contain;">
        </div>
    </div>

    <nav class="nav">
        <button id="btn-answers" class="nav-btn active" onclick="tab('answers')"><span class="nav-icon">üìö</span>–û—Ç–≤–µ—Ç—ã</button>
        <button id="btn-palettes" class="nav-btn" onclick="tab('palettes')"><span class="nav-icon">üé®</span>–ü–∞–ª–∏—Ç—Ä—ã</button>
        <button id="btn-shop" class="nav-btn" onclick="tab('shop')"><span class="nav-icon">üñçÔ∏è</span>–ú–∞—Ä–∫–µ—Ä—ã</button>
        <button id="btn-cart" class="nav-btn" onclick="tab('cart')">
            <span class="nav-icon">üõí</span>–ö–æ—Ä–∑–∏–Ω–∞
            <span id="cartBadge" class="badge" style="display:none">0</span>
        </button>
        <button id="btn-profile" class="nav-btn" onclick="tab('profile')"><span class="nav-icon">üë§</span>–ü—Ä–æ—Ñ–∏–ª—å</button>
    </nav>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        let markersData = [], cart = [], markersLoaded = false;

        const bookNames = ["Les Grands Classiques tome 11", "Les Grands Classiques tome 3", "Vitraux tome 2", "Trompe L'oeil Babies", "Trompe L'oeil Grand Bloc", "Stitch Au numero", "Sous L'Ocean", "Saisons", "Romantasy", "Princesses tome 1", "Princesses tome 2", "Princes&Heros", "Portraits De Famille", "Pokemon", "Pixar", "Petites Princesses", "Petites Betes", "Mondes Fantastiques", "Mickey, Donald&Co", "Mechants", "Marsupilami", "Love Stories", "Looney Tunes tome 3", "Lilo Et Stitch", "Les Grands Classiques Special Debutants tome 1", "Les Grands Classiques Special Debutants tome 2", "Les Grands Classiques Au numero", "La Petite Sirene", "Les Schtroumpfs tome 1", "Les Schtroumpfs tome 2", "L'age Glace", "Hiver", "Heros&Mechants La Battle", "Grands Classiques Grand Bloc", "Les Grands Classiques Coliector", "Girl Power", "Fees, Sorciers Et Magiciens", "Famille", "Escapades Merveilleuses Douce France", "Chiots&Chiens", "Chevaux", "Bisounours tome 1", "Best Of Pixar", "Best Of Les Grands Classiques", "La Belle Et La Bete", "Bestiaire", "Best Of Heroines"];

        function renderBooks(list = bookNames) {
            const grid = document.getElementById('booksGrid');
            grid.innerHTML = list.map((name) => {
                const originalId = bookNames.indexOf(name) + 1;
                const safeName = name.replace(/'/g, "\\'");
                const itemInCart = cart.find(c => c.key === '–†–∞—Å–∫—Ä–∞—Å–∫–∞-' + originalId);
                const btnText = itemInCart ? `–í –∫–æ—Ä–∑–∏–Ω–µ: ${itemInCart.qty}` : '–í –∫–æ—Ä–∑–∏–Ω—É';
                return `
                <div class="card">
                    <img src="img/t${originalId}.png" onclick="startBook(${originalId}, 26)">
                    <div class="card-label">${name}<br><span style="color:var(--accent); font-weight:bold;">2890 —Ä—É–±.</span><br><small style="color:var(--gray);">üì¶ –ü–æ–¥ –∑–∞–∫–∞–∑</small></div>
                    <button class="buy-btn" onclick="addToCart('–†–∞—Å–∫—Ä–∞—Å–∫–∞', '${safeName}', ${originalId}, 99, 2890)">${btnText}</button>
                </div>`;
            }).join('');
        }

        function filterBooks() {
            const query = document.getElementById('bookSearch').value.toLowerCase();
            renderBooks(bookNames.filter(name => name.toLowerCase().includes(query)));
        }

        async function loadMarkers() {
            const csvUrl = 'https://docs.google.com/spreadsheets/d/1Yrsif-aQwbuT6fLPnP4MsM22UuwuUWz5FYegELPxzFU/gviz/tq?tqx=out:csv&cache=' + new Date().getTime();
            try {
                const res = await fetch(csvUrl);
                const text = await res.text();
                const rows = text.split('\n').map(r => r.split(',').map(c => c.replace(/"/g, '').trim()));
                let temp = [];
                rows.forEach(row => {
                    for (let i = 0; i < row.length; i++) {
                        let num = row[i];
                        if (num && !isNaN(num) && parseInt(num) > 10) {
                            let stock = parseInt(row[i+1] || row[i+2] || "0");
                            temp.push({ number: num, stock: stock });
                            i++;
                        }
                    }
                });
                markersData = temp.filter((v, i, a) => a.findIndex(t => (t.number === v.number)) === i);
                cart.forEach(item => {
                    if (item.type === '–ú–∞—Ä–∫–µ—Ä') {
                        const m = markersData.find(md => md.number == item.id);
                        if (m) { item.max = m.stock; if (item.qty > m.stock) item.qty = m.stock; }
                    }
                });
                markersLoaded = true;
                renderMarkers(markersData);
                updateUI();
            } catch (e) { console.error(e); }
        }

        function renderMarkers(data) {
            const list = document.getElementById('markersList');
            const q = document.getElementById('markerSearch').value.toLowerCase();
            const filtered = data.filter(m => m.number.includes(q)).sort((a, b) => a.number - b.number);
            list.innerHTML = filtered.map(m => {
                const cartIndex = cart.findIndex(c => c.key === '–ú–∞—Ä–∫–µ—Ä-' + m.number);
                const currentQty = cartIndex > -1 ? cart[cartIndex].qty : 0;
                const canAdd = currentQty < m.stock;
                let color = m.stock >= 2 ? "#34c759" : (m.stock === 1 ? "#ff9500" : "#ff3b30");
                return `
                <div class="row-item">
                    <div class="item-info">
                        <span class="marker-num">‚Ññ ${m.number}</span>
                        <span class="stock-badge" style="color:${color}">${m.stock >= 1 ? `–í –Ω–∞–ª–∏—á–∏–∏: ${m.stock} —à—Ç.` : "–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏"}</span>
                    </div>
                    <div class="item-controls">
                        ${m.stock > 0 ? (currentQty > 0 ? `
                            <button class="btn-qty-sm" onclick="changeQty(${cartIndex}, -1)">-</button>
                            <span class="marker-qty">${currentQty}</span>
                            <button class="btn-qty-sm" ${!canAdd ? 'disabled' : ''} onclick="changeQty(${cartIndex}, 1)">+</button>
                        ` : `<button class="btn-qty-sm" onclick="addToCart('–ú–∞—Ä–∫–µ—Ä', '${m.number}', ${m.number}, ${m.stock}, 75)">+</button>`) : ''}
                    </div>
                </div>`;
            }).join('');
        }

        function addToCart(type, name, id, max, price) {
            const key = type + '-' + id;
            const existing = cart.find(i => i.key === key);
            if (existing) { if (existing.qty < max) existing.qty++; else return; }
            else { cart.push({ key, type, name, id, qty: 1, max, price }); }
            updateUI();
            if(type === '–ú–∞—Ä–∫–µ—Ä') renderMarkers(markersData);
            if(type === '–†–∞—Å–∫—Ä–∞—Å–∫–∞') renderBooks();
            tg.HapticFeedback.impactOccurred('light');
        }

        function updateUI() {
            const total = cart.reduce((sum, i) => sum + i.qty, 0);
            const badge = document.getElementById('cartBadge');
            badge.innerText = total;
            badge.style.display = total > 0 ? 'block' : 'none';
            document.getElementById('mainOrderBtn').style.display = total > 0 ? 'block' : 'none';
        }

        function renderCart() {
            const list = document.getElementById('cartList');
            if (cart.length === 0) { list.innerHTML = '<div style="text-align:center; padding:50px; color:var(--gray)">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>'; return; }
            const totalSum = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            
            let bonus = 0;
            if (totalSum >= 3000 && totalSum < 5000) bonus = 20;
            else if (totalSum >= 5000 && totalSum < 7500) bonus = 30;
            else if (totalSum >= 7500 && totalSum < 10000) bonus = 40;
            else if (totalSum >= 10000) bonus = 50;

            list.innerHTML = cart.map((item, index) => `
                <div class="row-item">
                    <div class="item-info"><b>${item.type === '–ú–∞—Ä–∫–µ—Ä' ? '‚Ññ ' : ''}${item.name}</b><div style="font-size:12px; color:var(--gray)">${item.price} —Ä—É–±./—à—Ç.</div></div>
                    <div class="item-controls">
                        <button class="btn-qty" onclick="changeQty(${index}, -1)">-</button>
                        <span class="qty-num">${item.qty}</span>
                        <button class="btn-qty" ${item.qty >= item.max ? 'disabled' : ''} onclick="changeQty(${index}, 1)">+</button>
                    </div>
                </div>`).join('') + `
                <div style="margin-top:20px; padding:15px; background:var(--secondary); border-radius:15px; text-align:right;">
                    <span style="color:var(--gray); font-size:14px;">–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</span>
                    <div style="font-size:20px; font-weight:800; color:var(--accent);">${totalSum} —Ä—É–±.</div>
                    <div class="bonus-badge" style="color:#E65100">–ë—É–¥–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–æ: +${bonus} <i class="fas fa-book-open"></i></div>
                </div>`;
        }

        function changeQty(index, delta) {
            const item = cart[index];
            if (delta > 0 && item.qty >= item.max) return;
            item.qty += delta;
            if (item.qty <= 0) cart.splice(index, 1);
            updateUI();
            if (document.getElementById('cart').classList.contains('active')) renderCart();
            if (document.getElementById('shop').classList.contains('active')) renderMarkers(markersData);
        }

        function checkout() {
            if (cart.length === 0) return;
            let markersCount = 0;
            cart.forEach(item => { if (item.type === '–ú–∞—Ä–∫–µ—Ä') markersCount += item.qty; });
            if (markersCount > 0 && markersCount < 3) {
                tg.showAlert("‚ö†Ô∏è –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∑–∞–∫–∞–∑ –º–∞—Ä–∫–µ—Ä–æ–≤ ‚Äî –æ—Ç 3 —à—Ç—É–∫.");
                return;
            }
            let totalSum = 0, hasPreorder = false;
            let details = `üõç **–î–ï–¢–ê–õ–ò –ó–ê–ö–ê–ó–ê:**\n`;
            cart.forEach(item => {
                const sum = item.price * item.qty; 
                totalSum += sum;
                if (item.type === '–†–∞—Å–∫—Ä–∞—Å–∫–∞') hasPreorder = true;
                details += `‚ñ™Ô∏è ${item.type} ${item.type === '–ú–∞—Ä–∫–µ—Ä' ? '‚Ññ' : '"'}${item.name}${item.type === '–ú–∞—Ä–∫–µ—Ä' ? '' : '"'}\n   - ${item.qty} —à—Ç. x ${item.price} = ${sum} —Ä—É–±.\n`;
            });

            let bonusToEarn = 0;
            if (totalSum >= 3000 && totalSum < 5000) bonusToEarn = 20;
            else if (totalSum >= 5000 && totalSum < 7500) bonusToEarn = 30;
            else if (totalSum >= 7500 && totalSum < 10000) bonusToEarn = 40;
            else if (totalSum >= 10000) bonusToEarn = 50;
            
            details += `\nüí∞ **–ò–¢–û–ì–û: ${totalSum} —Ä—É–±.**`;
            details += `\nüìñ **–ë–û–ù–£–° –ö –ù–ê–ß–ò–°–õ–ï–ù–ò–Æ: ${bonusToEarn}**`;
            details += `\nüë§ **–¢–ï–ö–£–©–ò–ô –ë–ê–õ–ê–ù–° –Æ–ó–ï–†–ê: ${document.getElementById('userBalance').innerText}**`;
            
            if (hasPreorder) {
                tg.showConfirm("–í –≤–∞—à–µ–º –∑–∞–∫–∞–∑–µ –µ—Å—Ç—å —Ä–∞—Å–∫—Ä–∞—Å–∫–∏ (–ü–û–î –ó–ê–ö–ê–ó). –û—Ñ–æ—Ä–º–∏—Ç—å?", (c) => { 
                    if(c) { tg.sendData(JSON.stringify({ details: details })); tg.close(); }
                });
            } else { 
                tg.sendData(JSON.stringify({ details: details })); tg.close(); 
            }
        }

        function tab(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.getElementById('btn-' + id).classList.add('active');
            if (id === 'shop') loadMarkers();
            if (id === 'cart') renderCart();
        }

        let currentVol, currentPage, maxPages, touchStartX, touchStartY;
        function startBook(v, m) { currentVol = v; maxPages = m; currentPage = 1; document.getElementById('viewer').style.display = 'block'; updatePage(); }
        function closeBook() { document.getElementById('viewer').style.display = 'none'; }
        function updatePage() {
            const img = document.getElementById('current-page'), counter = document.getElementById('page-counter'), formats = ['.jpg', '.png', '.jpeg', '.JPG', '.PNG'];
            let fIndex = 0;
            function tryLoad() { img.src = `otveti/t${currentVol}/${currentPage}${formats[fIndex]}`; }
            img.onerror = () => { fIndex++; if (fIndex < formats.length) tryLoad(); };
            tryLoad(); counter.innerText = `${currentPage} / ${maxPages}`;
        }

        function handleTouchStart(e) { touchStartX = e.touches[0].screenX; touchStartY = e.touches[0].screenY; }
        function handleTouchEnd(e) {
            let dx = touchStartX - e.changedTouches[0].screenX, dy = touchStartY - e.changedTouches[0].screenY;
            if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 40) {
                if (dx > 0 && currentPage < maxPages) { currentPage++; updatePage(); }
                else if (dx < 0 && currentPage > 1) { currentPage--; updatePage(); }
            }
        }
        function filterMarkers() { renderMarkers(markersData); }

        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            document.getElementById('userBalance').innerText = params.get('balance') || 0;
            document.getElementById('userIdDisplay').innerText = params.get('id') || tg.initDataUnsafe?.user?.id || "---";
        }
        renderBooks();
    </script>
</body>
</html>
