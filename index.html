<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: var(--tg-theme-bg-color, #ffffff);
            --text: var(--tg-theme-text-color, #000000);
            --accent: var(--tg-theme-button-color, #007aff);
            --accent-text: var(--tg-theme-button-text-color, #ffffff);
            --secondary: var(--tg-theme-secondary-bg-color, #f2f2f7);
            --gray: #8e8e93;
            --card-bg: var(--tg-theme-secondary-bg-color, #f1f1f1);
        }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 100px; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        .header { padding: 20px 15px; font-size: 24px; font-weight: 800; }
        .page { display: none; padding: 0 15px; }
        .page.active { display: block; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .card { background: var(--card-bg); border-radius: 18px; overflow: hidden; border: 0.5px solid rgba(128,128,128,0.2); display: flex; flex-direction: column; }
        .card img { width: 100%; height: 180px; object-fit: cover; cursor: pointer; background: #eee; }
        .card-label { padding: 10px; font-weight: 600; font-size: 13px; text-align: center; flex-grow: 1; line-height: 1.2; }
        .buy-btn { background: var(--accent); color: var(--accent-text); border: none; padding: 12px; font-weight: bold; cursor: pointer; width: 100%; transition: opacity 0.2s; border-radius: 10px; }
        .buy-btn:active { opacity: 0.7; }
        .buy-btn:disabled { background: var(--gray); opacity: 0.5; cursor: not-allowed; }
        .row-item { background: var(--card-bg); padding: 12px 15px; border-radius: 15px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; border: 0.5px solid rgba(128,128,128,0.1); }
        .counter-group { display: flex; align-items: center; gap: 12px; flex-shrink: 0; }
        .btn-qty { background: var(--accent); color: var(--accent-text); border: none; width: 34px; height: 34px; border-radius: 10px; font-weight: bold; font-size: 20px; display: flex; align-items: center; justify-content: center; }
        .btn-qty:disabled { background: var(--gray); opacity: 0.3; }
        .cart-info { flex-grow: 1; padding-right: 12px; min-width: 0; }
        .cart-info b { display: block; overflow-wrap: break-word; font-size: 14px; line-height: 1.3; }
        .marker-num { font-weight: 800; font-size: 18px; }
        .stock-badge { font-size: 13px; font-weight: bold; margin-top: 4px; display: block; }
        .category-title { margin: 20px 0 10px; font-size: 14px; color: var(--gray); text-transform: uppercase; font-weight: bold; }
        .nav { position: fixed; bottom: 0; width: 100%; height: 75px; background: var(--bg); display: flex; border-top: 0.5px solid rgba(128,128,128,0.3); z-index: 999; }
        .nav-btn { flex: 1; border: none; background: none; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 11px; color: var(--gray); }
        .nav-btn.active { color: var(--accent); }
        .nav-icon { font-size: 22px; margin-bottom: 4px; }
        .badge { position: absolute; top: 8px; right: 12%; background: #ff3b30; color: white; border-radius: 10px; padding: 2px 7px; font-size: 11px; font-weight: bold; }
        #viewer { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #000; z-index: 1000; }
        .viewer-header { padding: 15px; display: flex; justify-content: space-between; align-items: center; background: var(--bg); }
        input { width: 100%; padding: 14px; border-radius: 12px; border: none; background: var(--secondary); color: var(--text); margin-bottom: 15px; box-sizing: border-box; outline: none; }
        .total-row { margin-top: 15px; padding: 10px 5px; border-top: 1px solid rgba(128,128,128,0.2); display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 18px; }
    </style>
</head>
<body>

    <div id="answers" class="page active">
        <div class="header">–û—Ç–≤–µ—Ç—ã</div>
        <input type="text" id="bookSearch" placeholder="–ü–æ–∏—Å–∫ —Ç–æ–º–∞..." oninput="filterBooks()">
        <div id="booksGrid" class="grid"></div>
    </div>

    <div id="palettes" class="page">
        <div class="header">–ü–∞–ª–∏—Ç—Ä—ã</div>
        <div class="category-title">GuangNa</div>
        <div class="row-item"><span>GuangNa 120</span><button class="buy-btn" style="width:auto; padding: 8px 15px;" onclick="tg.openLink('https://hachettelittleheroes.github.io/HachetteLittleHeroesBot/palitri/guangna120.pdf')">PDF</button></div>
        <div class="row-item"><span>GuangNa 168</span><button class="buy-btn" style="width:auto; padding: 8px 15px;" onclick="tg.openLink('https://hachettelittleheroes.github.io/HachetteLittleHeroesBot/palitri/guangna168.pdf')">PDF</button></div>
        <div class="row-item"><span>GuangNa 240</span><button class="buy-btn" style="width:auto; padding: 8px 15px;" onclick="tg.openLink('https://hachettelittleheroes.github.io/HachetteLittleHeroesBot/palitri/guangna240.pdf')">PDF</button></div>
        <div class="row-item"><span>GuangNa 360</span><button class="buy-btn" style="width:auto; padding: 8px 15px;" onclick="tg.openLink('https://hachettelittleheroes.github.io/HachetteLittleHeroesBot/palitri/guangna360.pdf')">PDF</button></div>
        <div class="category-title">–î—Ä—É–≥–∏–µ</div>
        <div class="row-item"><span>Tooli-Art</span><button class="buy-btn" style="width:auto; padding: 8px 15px;" onclick="tg.openLink('https://hachettelittleheroes.github.io/HachetteLittleHeroesBot/palitri/tooliart.pdf')">PDF</button></div>
        <div class="row-item"><span>Grasp 168</span><button class="buy-btn" style="width:auto; padding: 8px 15px;" onclick="tg.openLink('https://hachettelittleheroes.github.io/HachetteLittleHeroesBot/palitri/grasp168.pdf')">PDF</button></div>
        <div class="row-item"><span>Zibeef 240</span><button class="buy-btn" style="width:auto; padding: 8px 15px;" onclick="tg.openLink('https://hachettelittleheroes.github.io/HachetteLittleHeroesBot/palitri/zibeef240.pdf')">PDF</button></div>
    </div>

    <div id="shop" class="page">
        <div class="header">–ú–∞—Ä–∫–µ—Ä—ã</div>
        <div class="category-title" style="display: flex; justify-content: space-between;"><span>GuangNa</span><span>75 —Ä—É–±/—à—Ç.</span></div>
        <input type="text" id="markerSearch" placeholder="–ü–æ–∏—Å–∫ –Ω–æ–º–µ—Ä–∞..." oninput="filterMarkers()">
        <div id="markersList"></div>
    </div>

    <div id="cart" class="page">
        <div class="header">–ö–æ—Ä–∑–∏–Ω–∞</div>
        <div id="cartList"></div>
        <button id="mainOrderBtn" class="buy-btn" style="padding: 18px; margin-top:10px; width:100%; font-size:16px; display: none;" onclick="checkout()">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
    </div>

    <div id="viewer">
        <div class="viewer-header">
            <button class="buy-btn" style="width:auto; padding: 8px 15px;" onclick="closeBook()">–ù–∞–∑–∞–¥</button>
            <div id="page-counter" style="font-weight:bold;"></div>
        </div>
        <div id="viewer-content" style="height: 85vh; display: flex; align-items: center; justify-content: center; overflow: hidden; touch-action: none;" ontouchstart="handleTouchStart(event)" ontouchend="handleTouchEnd(event)">
            <img src="" id="current-page" style="max-width: 100%; max-height: 100%; object-fit: contain;">
        </div>
    </div>

    <nav class="nav">
        <button id="btn-answers" class="nav-btn active" onclick="tab('answers')"><span class="nav-icon">üìö</span>–û—Ç–≤–µ—Ç—ã</button>
        <button id="btn-palettes" class="nav-btn" onclick="tab('palettes')"><span class="nav-icon">üé®</span>–ü–∞–ª–∏—Ç—Ä—ã</button>
        <button id="btn-shop" class="nav-btn" onclick="tab('shop')"><span class="nav-icon">üñçÔ∏è</span>–ú–∞—Ä–∫–µ—Ä—ã</button>
        <button id="btn-cart" class="nav-btn" onclick="tab('cart')">
            <span class="nav-icon">üõí</span>–ö–æ—Ä–∑–∏–Ω–∞
            <span id="cartBadge" class="badge" style="display:none">0</span>
        </button>
    </nav>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready(); tg.expand();

        const AMVERA_URL = 'https://amvera-hachettelittleheroes-run-bot.amvera.io';

        // –¢–ò–•–û–ï –û–¢–°–õ–ï–ñ–ò–í–ê–ù–ò–ï (–í–∏–∑–∏—Ç—ã)
        function initTracker() {
            if (sessionStorage.getItem('reported')) return;
            const u = tg.initDataUnsafe.user;
            if (!u) return;

            document.body.addEventListener('click', function track() {
                document.body.removeEventListener('click', track);
                fetch(`${AMVERA_URL}/track-visit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        id: u.id, 
                        first_name: u.first_name, 
                        username: u.username || '–Ω–µ—Ç –Ω–∏–∫–Ω–µ–π–º–∞' 
                    })
                }).then(() => sessionStorage.setItem('reported', 'true')).catch(e => console.log('Track error'));
            }, { once: true });
        }
        initTracker();

        let markersData = [], cart = [], markersLoaded = false;

        const bookNames = [
            "Les Grands Classiques tome 11", "Les Grands Classiques tome 3", "Vitraux tome 2", "Trompe L'oeil Babies", 
            "Trompe L'oeil Grands Blocs", "Stitch Au numero", "Sous L'Ocean", "Saisons", "Romantasy", 
            "Princesses tome 1", "Princesses tome 2", "Princes & Heros", "Portraits de Famille", "Pokemon", 
            "Pixar", "Petites Princesses", "Petites Betes", "Mondes Fantastiques", "Mickey & Co", 
            "Mechants", "Marsupilami", "Love Stories", "Looney Tunes tome 3", "Lilo Et Stitch", 
            "Debutants tome 1", "Debutants tome 2", "Au numero", "La Petite Sirene", "Schtroumpfs 1", 
            "Schtroumpfs 2", "L'age de Glace", "Hiver", "Heros & Mechants", "Grand Bloc", "Coliector", 
            "Girl Power", "Fees & Sorciers", "Famille", "Douce France", "Chiots & Chiens", "Chevaux", 
            "Bisounours", "Best Of Pixar", "Best Of Grands Classiques", "Belle Et La Bete", "Bestiaire", "Best Of Heroines"
        ];

        function renderBooks(list = bookNames) {
            const grid = document.getElementById('booksGrid');
            grid.innerHTML = list.map((name) => {
                const originalId = bookNames.indexOf(name) + 1;
                return `<div class="card">
                    <img src="img/t${originalId}.png" onclick="startBook(${originalId}, 26)">
                    <div class="card-label">${name}<br><b style="color:var(--accent)">2890 —Ä.</b></div>
                    <button class="buy-btn" onclick="addToCart('–†–∞—Å–∫—Ä–∞—Å–∫–∞', '${name.replace(/'/g, "")}', ${originalId}, 99, 2890)">–í –∫–æ—Ä–∑–∏–Ω—É</button>
                </div>`;
            }).join('');
        }

        async function loadMarkers() {
            if (markersLoaded) { renderMarkers(markersData); return; }
            const csvUrl = 'https://docs.google.com/spreadsheets/d/1Yrsif-aQwbuT6fLPnP4MsM22UuwuUWz5FYegELPxzFU/gviz/tq?tqx=out:csv';
            try {
                const res = await fetch(csvUrl);
                const text = await res.text();
                const rows = text.split('\n').map(r => r.split(',').map(c => c.replace(/"/g, '').trim()));
                let temp = [];
                rows.forEach(row => {
                    for (let i = 0; i < row.length; i++) {
                        let num = row[i];
                        if (num && !isNaN(num) && parseInt(num) > 10) {
                            let stock = parseInt(row[i+1] || row[i+2] || "0");
                            temp.push({ number: num, stock: stock });
                            i++;
                        }
                    }
                });
                markersData = temp.filter((v, i, a) => a.findIndex(t => (t.number === v.number)) === i);
                markersLoaded = true;
                renderMarkers(markersData);
            } catch (e) { console.error(e); }
        }

        function renderMarkers(data) {
            const list = document.getElementById('markersList');
            data.sort((a, b) => a.number - b.number);
            list.innerHTML = data.map(m => {
                const item = cart.find(c => c.key === '–ú–∞—Ä–∫–µ—Ä-' + m.number);
                const canAdd = (item ? item.qty : 0) < m.stock;
                let color = m.stock >= 2 ? "#34c759" : (m.stock === 1 ? "#ff9500" : "#ff3b30");
                return `<div class="row-item">
                    <div><span class="marker-num">‚Ññ ${m.number}</span><span class="stock-badge" style="color:${color}">${m.stock>0?'–í –Ω–∞–ª–∏—á–∏–∏: '+m.stock+' —à—Ç.':'–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏'}</span></div>
                    <button class="btn-qty" ${!canAdd?'disabled':''} onclick="addToCart('–ú–∞—Ä–∫–µ—Ä', '${m.number}', ${m.number}, ${m.stock}, 75)">+</button>
                </div>`;
            }).join('');
        }

        function addToCart(type, name, id, max, price) {
            const key = type + '-' + id;
            const item = cart.find(i => i.key === key);
            if (item) { if (item.qty < max) item.qty++; else return; }
            else { cart.push({ key, type, name, id, qty: 1, max, price }); }
            updateUI();
            if(type === '–ú–∞—Ä–∫–µ—Ä') renderMarkers(markersData);
            tg.HapticFeedback.impactOccurred('light');
        }

        function updateUI() {
            const total = cart.reduce((sum, i) => sum + i.qty, 0);
            const badge = document.getElementById('cartBadge');
            badge.innerText = total; badge.style.display = total > 0 ? 'block' : 'none';
            document.getElementById('mainOrderBtn').style.display = total > 0 ? 'block' : 'none';
        }

        function renderCart() {
            const list = document.getElementById('cartList');
            if (cart.length === 0) { list.innerHTML = '<div style="text-align:center; padding:50px; color:var(--gray)">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>'; return; }
            const totalSum = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            list.innerHTML = cart.map((item, idx) => `
                <div class="row-item">
                    <div class="cart-info"><b>${item.type==='–ú–∞—Ä–∫–µ—Ä'?'‚Ññ ':''}${item.name}</b><small style="color:var(--gray)">${item.price} —Ä/—à—Ç.</small></div>
                    <div class="counter-group">
                        <button class="btn-qty" onclick="changeQty(${idx}, -1)">-</button>
                        <span style="font-weight:bold; min-width:20px; text-align:center;">${item.qty}</span>
                        <button class="btn-qty" ${item.qty>=item.max?'disabled':''} onclick="changeQty(${idx}, 1)">+</button>
                    </div>
                </div>`).join('') + `<div class="total-row"><span>–ò—Ç–æ–≥–æ:</span><span>${totalSum} —Ä—É–±.</span></div>`;
        }

        function changeQty(idx, delta) {
            cart[idx].qty += delta;
            if (cart[idx].qty <= 0) cart.splice(idx, 1);
            renderCart(); updateUI();
        }
// --- –û–§–û–†–ú–õ–ï–ù–ò–ï –ó–ê–ö–ê–ó–ê (–°–¢–ê–†–´–ô, 100% –†–ê–ë–û–ß–ò–ô –ú–ï–¢–û–î) ---
function checkout() {
    if(cart.length === 0) return;
    const u = tg.initDataUnsafe.user;
    
    // –°—á–∏—Ç–∞–µ–º –æ–±—â—É—é —Å—É–º–º—É
    const totalSum = cart.reduce((sum, i) => sum + (i.price * i.qty), 0);
    
    let msg = `üõç **–ó–ê–ö–ê–ó –û–¢ @${u?.username || u?.first_name || '–ê–Ω–æ–Ω–∏–º'}**\n\n` + 
              cart.map(i => `‚ñ™Ô∏è ${i.type} ${i.name} - ${i.qty} —à—Ç.`).join('\n') +
              `\n\nüí∞ –°—É–º–º–∞: ${totalSum} —Ä.`;

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞–ø—Ä—è–º—É—é –≤ —Ç–≤–æ–µ–≥–æ –±–æ—Ç–∞ (–∫–∞–∫ –±—ã–ª–æ —Ä–∞–Ω—å—à–µ)
    tg.sendData(JSON.stringify({ details: msg }));
    tg.close();
}
        function tab(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.getElementById('btn-' + id).classList.add('active');
            if (id === 'shop') loadMarkers(); else if (id === 'cart') renderCart();
        }

        let currentVol, currentPage, maxPages, touchStartX;
        function startBook(v, m) { currentVol = v; maxPages = m; currentPage = 1; document.getElementById('viewer').style.display = 'block'; updatePage(); }
        function closeBook() { document.getElementById('viewer').style.display = 'none'; }
        function updatePage() {
            const img = document.getElementById('current-page');
            const formats = ['.jpg', '.png', '.jpeg', '.JPG', '.PNG'];
            let fIndex = 0;
            function tryLoad() { img.src = `otveti/t${currentVol}/${currentPage}${formats[fIndex]}`; }
            img.onerror = () => { fIndex++; if (fIndex < formats.length) tryLoad(); };
            tryLoad();
            document.getElementById('page-counter').innerText = `${currentPage} / ${maxPages}`;
        }
        function handleTouchStart(e) { touchStartX = e.touches[0].screenX; }
        function handleTouchEnd(e) {
            let diff = touchStartX - e.changedTouches[0].screenX;
            if (Math.abs(diff) > 50) {
                if (diff > 0 && currentPage < maxPages) { currentPage++; updatePage(); }
                else if (diff < 0 && currentPage > 1) { currentPage--; updatePage(); }
            }
        }
        function filterBooks() {
            const q = document.getElementById('bookSearch').value.toLowerCase();
            renderBooks(bookNames.filter(n => n.toLowerCase().includes(q)));
        }
        function filterMarkers() {
            const q = document.getElementById('markerSearch').value.toLowerCase();
            renderMarkers(markersData.filter(m => m.number.includes(q)));
        }
        renderBooks();
    </script>
</body>
</html>
