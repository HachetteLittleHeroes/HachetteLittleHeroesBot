<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: var(--tg-theme-bg-color, #ffffff);
            --text: var(--tg-theme-text-color, #000000);
            --accent: var(--tg-theme-button-color, #007aff);
            --accent-text: var(--tg-theme-button-text-color, #ffffff);
            --secondary: var(--tg-theme-secondary-bg-color, #f2f2f7);
            --gray: #8e8e93;
            --card-bg: var(--tg-theme-secondary-bg-color, #f1f1f1);
        }

        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 100px; }
        .header { padding: 20px 15px; font-size: 22px; font-weight: 800; }
        .page { display: none; padding: 0 15px; }
        .page.active { display: block; }

        /* –°–µ—Ç–∫–∞ –∫–Ω–∏–≥ */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .card { background: var(--card-bg); border-radius: 15px; overflow: hidden; border: 0.5px solid rgba(128,128,128,0.2); display: flex; flex-direction: column; }
        .card img { width: 100%; height: 140px; object-fit: cover; }
        .card-label { padding: 8px; font-weight: 600; font-size: 12px; text-align: center; flex-grow: 1; color: var(--text); }
        
        .buy-btn { background: var(--accent); color: var(--accent-text); border: none; padding: 10px; font-weight: bold; cursor: pointer; width: 100%; font-size: 12px; }
        .buy-btn:disabled { background: var(--gray); opacity: 0.4; cursor: not-allowed; }

        /* –°–ø–∏—Å–æ–∫ –º–∞—Ä–∫–µ—Ä–æ–≤ */
        .row-item { background: var(--card-bg); padding: 12px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .marker-info { display: flex; flex-direction: column; }
        .marker-num { font-weight: 800; color: var(--text); font-size: 16px; }
        .marker-stock { font-size: 11px; color: var(--gray); }

        .counter { display: flex; align-items: center; gap: 8px; }
        .btn-qty { background: var(--accent); color: var(--accent-text); border: none; width: 28px; height: 28px; border-radius: 6px; font-weight: bold; }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .nav { position: fixed; bottom: 0; width: 100%; height: 70px; background: var(--bg); display: flex; border-top: 0.5px solid rgba(128,128,128,0.3); z-index: 999; }
        .nav-btn { flex: 1; border: none; background: none; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; color: var(--gray); }
        .nav-btn.active { color: var(--accent); }
        .badge { position: absolute; top: 8px; right: 20%; background: #ff3b30; color: white; border-radius: 10px; padding: 2px 6px; font-size: 10px; }

        #viewer { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: var(--bg); z-index: 1000; }
        input { width: 100%; padding: 12px; border-radius: 10px; border: none; background: var(--secondary); color: var(--text); margin-bottom: 10px; box-sizing: border-box; }
    </style>
</head>
<body>

    <div id="answers" class="page active">
        <div class="header">–ö–æ–ª–ª–µ–∫—Ü–∏—è (47 —Ç–æ–º–æ–≤)</div>
        <div class="grid" id="booksGrid"></div>
    </div>

    <div id="shop" class="page">
        <div class="header">–ú–∞—Ä–∫–µ—Ä—ã GuangNa</div>
        <input type="text" id="markerSearch" placeholder="–ü–æ–∏—Å–∫ –Ω–æ–º–µ—Ä–∞..." oninput="filterMarkers()">
        <div id="markersList"></div>
    </div>

    <div id="cart" class="page">
        <div class="header">–ö–æ—Ä–∑–∏–Ω–∞</div>
        <div id="cartList"></div>
        <div id="cartTotal" style="padding: 20px; font-weight: bold; text-align: right;"></div>
        <button id="mainOrderBtn" class="buy-btn" style="border-radius: 12px; padding: 15px; display: none;" onclick="checkout()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</button>
    </div>

    <div id="viewer">
        <div style="padding: 15px; display: flex; justify-content: space-between;"><button class="buy-btn" style="width:auto" onclick="closeBook()">–ó–∞–∫—Ä—ã—Ç—å</button><div id="page-counter"></div></div>
        <div style="height: 80vh; display: flex; align-items: center; justify-content: center;" ontouchstart="handleTouchStart(event)" ontouchend="handleTouchEnd(event)">
            <img src="" id="current-page" style="max-width: 95%; max-height: 100%;">
        </div>
    </div>

    <nav class="nav">
        <button id="btn-answers" class="nav-btn active" onclick="tab('answers')">üìö<br>–û—Ç–≤–µ—Ç—ã</button>
        <button id="btn-shop" class="nav-btn" onclick="tab('shop')">üñçÔ∏è<br>–ú–∞–≥–∞–∑–∏–Ω</button>
        <button id="btn-cart" class="nav-btn" onclick="tab('cart')">üõí<br>–ö–æ—Ä–∑–∏–Ω–∞<span id="cartBadge" class="badge" style="display:none">0</span></button>
    </nav>

    <script>
        const tg = window.Telegram.WebApp;
        let markersData = [], cart = [];
        const availableVolumes = [1, 2, 9]; // –¢–æ–º–∞, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –∫—É–ø–∏—Ç—å (t1, t2, t9)

        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö 47 —Ç–æ–º–æ–≤
        const bookNames = [
            "L.G. Classiques t11", "L.G. Classiques t3", "Vitraux t2", "Trompe L'oeil Babies", 
            "Trompe L'oeil G.B.", "Stitch Au numero", "Sous L'Ocean", "Saisons", "Romantasy", 
            "Princesses t1", "Princesses t2", "Princes&Heros", "Portraits Famille", "Pokemon", 
            "Pixar", "Petites Princesses", "Petites Betes", "Mondes Fantastiques", "Mickey&Co", 
            "Mechants", "Marsupilami", "Love Stories", "Looney Tunes t3", "Lilo Et Stitch", 
            "Debutants t1", "Debutants t2", "Au numero", "La Petite Sirene", "Schtroumpfs 1", 
            "Schtroumpfs 2", "L'age Glace", "Hiver", "Heros&Mechants", "Grand Bloc", "Coliector", 
            "Girl Power", "Fees&Sorciers", "Famille", "Douce France", "Chiots&Chiens", "Chevaux", 
            "Bisounours", "Best Of Pixar", "Best Of G.C.", "Belle Et La Bete", "Bestiaire", "Best Of Heroines"
        ];

        function renderBooks() {
            const grid = document.getElementById('booksGrid');
            grid.innerHTML = bookNames.map((name, i) => {
                const id = i + 1;
                const isAvailable = availableVolumes.includes(id);
                const inCart = cart.find(item => item.key === '–¢–æ–º-'+id);
                return `
                <div class="card">
                    <img src="img/t${id}.png" onclick="startBook(${id}, 26)">
                    <div class="card-label">${name}</div>
                    ${isAvailable 
                        ? `<button class="buy-btn" ${inCart ? 'disabled' : ''} onclick="addToCart('–¢–æ–º', '${name}', ${id}, 1)">
                            ${inCart ? '–í –∫–æ—Ä–∑–∏–Ω–µ' : '–ö—É–ø–∏—Ç—å (1 —à—Ç)'}</button>`
                        : `<div style="padding:10px; font-size:10px; color:var(--gray); text-align:center">–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</div>`}
                </div>`;
            }).join('');
        }

        async function loadMarkers() {
            const csvUrl = 'https://docs.google.com/spreadsheets/d/1Yrsif-aQwbuT6fLPnP4MsM22UuwuUWz5FYegELPxzFU/gviz/tq?tqx=out:csv';
            try {
                const res = await fetch(csvUrl);
                const text = await res.text();
                const rows = text.split('\n').map(r => r.split(',').map(c => c.replace(/"/g, '').trim()));
                let temp = [];
                rows.forEach(row => {
                    for (let i = 0; i < row.length; i++) {
                        let num = row[i];
                        if (num && !isNaN(num) && parseInt(num) > 10) {
                            let stock = parseInt(row[i+1] || row[i+2] || "0");
                            temp.push({ number: num, stock: stock });
                            i++;
                        }
                    }
                });
                markersData = temp.filter((v, i, a) => a.findIndex(t => (t.number === v.number)) === i);
                renderMarkers(markersData);
            } catch (e) { console.error(e); }
        }

        function renderMarkers(data) {
            const list = document.getElementById('markersList');
            data.sort((a,b) => a.number - b.number);
            list.innerHTML = data.map(m => {
                const itemInCart = cart.find(c => c.key === '–ú–∞—Ä–∫–µ—Ä-'+m.number);
                const currentQty = itemInCart ? itemInCart.qty : 0;
                const canAdd = currentQty < m.stock;

                return `
                <div class="row-item">
                    <div class="marker-info">
                        <span class="marker-num">‚Ññ ${m.number}</span>
                        <span class="marker-stock">–í –Ω–∞–ª–∏—á–∏–∏: ${m.stock} —à—Ç.</span>
                    </div>
                    <div class="counter">
                        ${m.stock > 0 
                            ? `<button class="btn-qty" ${!canAdd ? 'style="opacity:0.3"' : ''} onclick="addToCart('–ú–∞—Ä–∫–µ—Ä', '${m.number}', ${m.number}, ${m.stock})">+</button>` 
                            : '<span style="color:#ff3b30; font-size:11px;">–ù–µ—Ç</span>'}
                    </div>
                </div>`;
            }).join('');
        }

        function addToCart(type, name, id, maxStock) {
            const key = type + '-' + id;
            const existing = cart.find(i => i.key === key);
            if (existing) {
                if (existing.qty < maxStock) existing.qty++;
                else { tg.showAlert("–ë–æ–ª—å—à–µ –Ω–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏!"); return; }
            } else {
                cart.push({ key, type, name, id, qty: 1, max: maxStock });
            }
            updateUI();
            if(type === '–ú–∞—Ä–∫–µ—Ä') renderMarkers(markersData);
            tg.HapticFeedback.impactOccurred('light');
        }

        function updateUI() {
            const total = cart.reduce((sum, i) => sum + i.qty, 0);
            const badge = document.getElementById('cartBadge');
            badge.innerText = total;
            badge.style.display = total > 0 ? 'block' : 'none';
            document.getElementById('mainOrderBtn').style.display = total > 0 ? 'block' : 'none';
            renderBooks();
        }

        function renderCart() {
            const list = document.getElementById('cartList');
            if (cart.length === 0) { list.innerHTML = '<div style="text-align:center; padding:50px; color:var(--gray)">–ü—É—Å—Ç–æ</div>'; return; }
            list.innerHTML = cart.map((item, index) => `
                <div class="row-item">
                    <div><b>${item.type === '–ú–∞—Ä–∫–µ—Ä' ? '‚Ññ ' : ''}${item.name}</b></div>
                    <div class="counter">
                        <button class="btn-qty" onclick="changeQty(${index}, -1)">-</button>
                        <span>${item.qty}</span>
                        <button class="btn-qty" onclick="changeQty(${index}, 1)">+</button>
                    </div>
                </div>`).join('');
        }

        function changeQty(index, delta) {
            const item = cart[index];
            if (delta > 0 && item.qty >= item.max) { tg.showAlert("–≠—Ç–æ –º–∞–∫—Å–∏–º—É–º!"); return; }
            item.qty += delta;
            if (item.qty <= 0) cart.splice(index, 1);
            renderCart();
            updateUI();
        }

        function checkout() {
            const orderText = cart.map(i => `${i.type} ${i.name} (${i.qty} —à—Ç.)`).join('\n');
            tg.sendData(JSON.stringify({action: "order", details: orderText}));
        }

        function tab(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.getElementById('btn-' + id).classList.add('active');
            if (id === 'shop') loadMarkers();
            if (id === 'cart') renderCart();
        }

        // –ë–∞–∑–æ–≤—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä—â–∏–∫ (–æ—Å—Ç–∞–≤–∏–ª –∫–∞–∫ –±—ã–ª)
        let currentVol, currentPage, maxPages, touchStartX;
        function startBook(v, m) { currentVol=v; maxPages=m; currentPage=1; document.getElementById('viewer').style.display='block'; updatePage(); }
        function closeBook() { document.getElementById('viewer').style.display='none'; }
        function updatePage() {
            document.getElementById('current-page').src = `otveti/t${currentVol}/${currentPage}.jpg`;
            document.getElementById('page-counter').innerText = `${currentPage} / ${maxPages}`;
        }
        function handleTouchStart(e) { touchStartX = e.touches[0].screenX; }
        function handleTouchEnd(e) {
            let diff = touchStartX - e.changedTouches[0].screenX;
            if (diff > 50 && currentPage < maxPages) { currentPage++; updatePage(); }
            if (diff < -50 && currentPage > 1) { currentPage--; updatePage(); }
        }

        function filterMarkers() {
            const q = document.getElementById('markerSearch').value;
            renderMarkers(markersData.filter(m => m.number.includes(q)));
        }

        renderBooks();
    </script>
</body>
</html>
