<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: var(--tg-theme-bg-color, #ffffff);
            --text: var(--tg-theme-text-color, #000000);
            --accent: var(--tg-theme-button-color, #007aff);
            --accent-text: var(--tg-theme-button-text-color, #ffffff);
            --secondary: var(--tg-theme-secondary-bg-color, #f2f2f7);
            --gray: #8e8e93;
            --card-bg: var(--tg-theme-secondary-bg-color, #f1f1f1);
        }

        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 100px; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        .header { padding: 20px 15px; font-size: 24px; font-weight: 800; }
        .page { display: none; padding: 0 15px; }
        .page.active { display: block; }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .card { background: var(--card-bg); border-radius: 18px; overflow: hidden; border: 0.5px solid rgba(128,128,128,0.2); display: flex; flex-direction: column; }
        .card img { width: 100%; height: 180px; object-fit: cover; cursor: pointer; background: #eee; }
        .card-label { padding: 10px; font-weight: 600; font-size: 14px; text-align: center; flex-grow: 1; }
        
        .buy-btn { background: var(--accent); color: var(--accent-text); border: none; padding: 12px; font-weight: bold; cursor: pointer; width: 100%; }
        .btn-qty { background: var(--accent); color: var(--accent-text); border: none; width: 35px; height: 35px; border-radius: 10px; font-weight: bold; font-size: 20px; }

        .row-item { background: var(--card-bg); padding: 15px; border-radius: 15px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; border: 0.5px solid rgba(128,128,128,0.1); }
        .marker-num { font-weight: 800; font-size: 18px; color: var(--text); }
        .stock-badge { font-size: 13px; font-weight: bold; margin-top: 4px; display: block; }
        .category-title { margin: 20px 0 10px; font-size: 14px; color: var(--gray); text-transform: uppercase; font-weight: bold; }

        .nav { position: fixed; bottom: 0; width: 100%; height: 75px; background: var(--bg); display: flex; border-top: 0.5px solid rgba(128,128,128,0.3); z-index: 999; }
        .nav-btn { flex: 1; border: none; background: none; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 11px; color: var(--gray); }
        .nav-btn.active { color: var(--accent); }
        .nav-icon { font-size: 22px; margin-bottom: 4px; }
        .badge { position: absolute; top: 8px; right: 12%; background: #ff3b30; color: white; border-radius: 10px; padding: 2px 7px; font-size: 11px; }

        #viewer { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #000; z-index: 1000; }
        .viewer-header { padding: 15px; display: flex; justify-content: space-between; align-items: center; background: var(--bg); border-bottom: 0.5px solid rgba(128,128,128,0.2); }
        
        input { width: 100%; padding: 14px; border-radius: 12px; border: none; background: var(--secondary); color: var(--text); margin-bottom: 15px; box-sizing: border-box; outline: none; }
    </style>
</head>
<body>

    <div id="answers" class="page active">
        <div class="header">–û—Ç–≤–µ—Ç—ã</div>
        <input type="text" id="bookSearch" placeholder="–ü–æ–∏—Å–∫ —Ç–æ–º–∞..." oninput="filterBooks()">
        <div class="grid" id="booksGrid"></div>
    </div>

    <div id="palettes" class="page">
        <div class="header">–ü–∞–ª–∏—Ç—Ä—ã</div>
        <div class="category-title">GuangNa</div>
        <div class="row-item"><span>GuangNa 120</span><button class="buy-btn" style="width:auto; border-radius:8px; padding: 8px 15px;" onclick="tg.openLink('https://hachettelittleheroes.github.io/HachetteLittleHeroesBot/palitri/guangna120.pdf')">PDF</button></div>
        <div class="row-item"><span>GuangNa 168</span><button class="buy-btn" style="width:auto; border-radius:8px; padding: 8px 15px;" onclick="tg.openLink('https://hachettelittleheroes.github.io/HachetteLittleHeroesBot/palitri/guangna168.pdf')">PDF</button></div>
        <div class="row-item"><span>GuangNa 240</span><button class="buy-btn" style="width:auto; border-radius:8px; padding: 8px 15px;" onclick="tg.openLink('https://hachettelittleheroes.github.io/HachetteLittleHeroesBot/palitri/guangna240.pdf')">PDF</button></div>
        <div class="row-item"><span>GuangNa 360</span><button class="buy-btn" style="width:auto; border-radius:8px; padding: 8px 15px;" onclick="tg.openLink('https://hachettelittleheroes.github.io/HachetteLittleHeroesBot/palitri/guangna360.pdf')">PDF</button></div>
        <div class="category-title">–î—Ä—É–≥–∏–µ</div>
        <div class="row-item"><span>Tooli-Art</span><button class="buy-btn" style="width:auto; border-radius:8px; padding: 8px 15px;" onclick="tg.openLink('https://hachettelittleheroes.github.io/HachetteLittleHeroesBot/palitri/tooliart.pdf')">PDF</button></div>
        <div class="row-item"><span>Grasp 168</span><button class="buy-btn" style="width:auto; border-radius:8px; padding: 8px 15px;" onclick="tg.openLink('https://hachettelittleheroes.github.io/HachetteLittleHeroesBot/palitri/grasp168.pdf')">PDF</button></div>
        <div class="row-item"><span>Zibeef 240</span><button class="buy-btn" style="width:auto; border-radius:8px; padding: 8px 15px;" onclick="tg.openLink('https://hachettelittleheroes.github.io/HachetteLittleHeroesBot/palitri/zibeef240.pdf')">PDF</button></div>
    </div>

    <div id="shop" class="page">
        <div class="header">–ú–∞—Ä–∫–µ—Ä—ã</div>
        <div class="category-title" style="margin-top: 0; display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px;">
            <span>GuangNa</span>
            <span style="color: var(--accent); text-transform: none; font-size: 15px;">75 —Ä—É–±./—à—Ç.</span>
        </div>
        <input type="text" id="markerSearch" placeholder="–ü–æ–∏—Å–∫ –Ω–æ–º–µ—Ä–∞..." oninput="filterMarkers()">
        <div id="markersList"></div>
    </div>

    <div id="cart" class="page">
        <div class="header">–ö–æ—Ä–∑–∏–Ω–∞</div>
        <div id="cartList"></div>
        <button id="mainOrderBtn" class="buy-btn" style="border-radius: 15px; padding: 18px; margin-top:20px; display: none;" onclick="checkout()">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
    </div>

    <div id="viewer">
        <div class="viewer-header">
            <button class="buy-btn" style="width:auto; border-radius:8px; padding: 8px 15px;" onclick="closeBook()">–ù–∞–∑–∞–¥</button>
            <div id="page-counter" style="color:var(--text); font-weight:bold;"></div>
        </div>
        <div id="viewer-content" style="height: 85vh; display: flex; align-items: center; justify-content: center; overflow: hidden; touch-action: none;" ontouchstart="handleTouchStart(event)" ontouchend="handleTouchEnd(event)">
            <img src="" id="current-page" style="max-width: 100%; max-height: 100%; object-fit: contain;">
        </div>
    </div>

    <nav class="nav">
        <button id="btn-answers" class="nav-btn active" onclick="tab('answers')"><span class="nav-icon">üìö</span>–û—Ç–≤–µ—Ç—ã</button>
        <button id="btn-palettes" class="nav-btn" onclick="tab('palettes')"><span class="nav-icon">üé®</span>–ü–∞–ª–∏—Ç—Ä—ã</button>
        <button id="btn-shop" class="nav-btn" onclick="tab('shop')"><span class="nav-icon">üñçÔ∏è</span>–ú–∞—Ä–∫–µ—Ä—ã</button>
        <button id="btn-cart" class="nav-btn" onclick="tab('cart')">
            <span class="nav-icon">üõí</span>–ö–æ—Ä–∑–∏–Ω–∞
            <span id="cartBadge" class="badge" style="display:none">0</span>
        </button>
    </nav>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        let markersData = [], cart = [];

        const bookNames = [
            "Classiques t11", "Classiques t3", "Vitraux t2", "Trompe L'oeil Babies", 
            "Trompe L'oeil G.B.", "Stitch Au numero", "Sous L'Ocean", "Saisons", "Romantasy", 
            "Princesses t1", "Princesses t2", "Princes&Heros", "Portraits Famille", "Pokemon", 
            "Pixar", "Petites Princesses", "Petites Betes", "Mondes Fantastiques", "Mickey&Co", 
            "Mechants", "Marsupilami", "Love Stories", "Looney Tunes t3", "Lilo Et Stitch", 
            "Debutants t1", "Debutants t2", "Au numero", "La Petite Sirene", "Schtroumpfs 1", 
            "Schtroumpfs 2", "L'age Glace", "Hiver", "Heros&Mechants", "Grand Bloc", "Coliector", 
            "Girl Power", "Fees&Sorciers", "Famille", "Douce France", "Chiots&Chiens", "Chevaux", 
            "Bisounours", "Best Of Pixar", "Best Of G.C.", "Belle Et La Bete", "Bestiaire", "Best Of Heroines"
        ];

        function renderBooks(list = bookNames) {
            const grid = document.getElementById('booksGrid');
            grid.innerHTML = list.map((name) => {
                const originalId = bookNames.indexOf(name) + 1;
                const price = 2890; 
                // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –∫–∞–≤—ã—á–∫–∏ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ –¥–ª—è JS
                const safeName = name.replace(/'/g, "\\'");
                
                return `
                <div class="card">
                    <img src="img/t${originalId}.png" onclick="startBook(${originalId}, 26)">
                    <div class="card-label">
                        ${name}<br>
                        <span style="color:var(--accent); font-weight:bold;">${price} —Ä—É–±.</span><br>
                        <small style="color:var(--gray);">üì¶ –ü–æ–¥ –∑–∞–∫–∞–∑</small>
                    </div>
                    <button class="buy-btn" onclick="addToCart('–†–∞—Å–∫—Ä–∞—Å–∫–∞', '${safeName}', ${originalId}, 99, ${price})">–í –∫–æ—Ä–∑–∏–Ω—É</button>
                </div>`;
            }).join('');
        }

        function filterBooks() {
            const query = document.getElementById('bookSearch').value.toLowerCase();
            const filtered = bookNames.filter(name => name.toLowerCase().includes(query));
            renderBooks(filtered);
        }

        async function loadMarkers() {
            const csvUrl = 'https://docs.google.com/spreadsheets/d/1Yrsif-aQwbuT6fLPnP4MsM22UuwuUWz5FYegELPxzFU/gviz/tq?tqx=out:csv';
            try {
                const res = await fetch(csvUrl);
                const text = await res.text();
                const rows = text.split('\n').map(r => r.split(',').map(c => c.replace(/"/g, '').trim()));
                let temp = [];
                rows.forEach(row => {
                    for (let i = 0; i < row.length; i++) {
                        let num = row[i];
                        if (num && !isNaN(num) && parseInt(num) > 10) {
                            let stock = parseInt(row[i+1] || row[i+2] || "0");
                            temp.push({ number: num, stock: stock });
                            i++;
                        }
                    }
                });
                markersData = temp.filter((v, i, a) => a.findIndex(t => (t.number === v.number)) === i);
                renderMarkers(markersData);
            } catch (e) { console.error(e); }
        }

        function renderMarkers(data) {
            const list = document.getElementById('markersList');
            data.sort((a, b) => a.number - b.number);
            list.innerHTML = data.map(m => {
                const itemInCart = cart.find(c => c.key === '–ú–∞—Ä–∫–µ—Ä-' + m.number);
                const currentQty = itemInCart ? itemInCart.qty : 0;
                const canAdd = currentQty < m.stock;
                const markerPrice = 75; 
                
                let color = m.stock >= 2 ? "#34c759" : (m.stock === 1 ? "#ff9500" : "#ff3b30");
                let text = m.stock >= 1 ? `–í –Ω–∞–ª–∏—á–∏–∏: ${m.stock} —à—Ç.` : "–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏";
                
                return `
                <div class="row-item">
                    <div>
                        <span class="marker-num">‚Ññ ${m.number}</span>
                        <span class="stock-badge" style="color:${color}">${text}</span>
                    </div>
                    <div class="counter">
                        ${m.stock > 0 ? `<button class="btn-qty" ${!canAdd ? 'style="opacity:0.3"' : ''} onclick="addToCart('–ú–∞—Ä–∫–µ—Ä', '${m.number}', ${m.number}, ${m.stock}, ${markerPrice})">+</button>` : ''}
                    </div>
                </div>`;
            }).join('');
        }

        function addToCart(type, name, id, max, price = 0) {
            const key = type + '-' + id;
            const existing = cart.find(i => i.key === key);
            if (existing) {
                if (existing.qty < max) existing.qty++;
                else { tg.showAlert("–ë–æ–ª—å—à–µ –Ω–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏!"); return; }
            } else {
                cart.push({ key, type, name, id, qty: 1, max, price: price });
            }
            updateUI();
            if(type === '–ú–∞—Ä–∫–µ—Ä') renderMarkers(markersData);
            tg.HapticFeedback.impactOccurred('light');
        }

        function updateUI() {
            const total = cart.reduce((sum, i) => sum + i.qty, 0);
            const badge = document.getElementById('cartBadge');
            badge.innerText = total;
            badge.style.display = total > 0 ? 'block' : 'none';
            document.getElementById('mainOrderBtn').style.display = total > 0 ? 'block' : 'none';
        }

        function renderCart() {
            const list = document.getElementById('cartList');
            if (cart.length === 0) { 
                list.innerHTML = '<div style="text-align:center; padding:50px; color:var(--gray)">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>'; 
                return; 
            }
            const totalSum = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            let html = cart.map((item, index) => `
                <div class="row-item">
                    <div>
                        <b>${item.type === '–ú–∞—Ä–∫–µ—Ä' ? '‚Ññ ' : ''}${item.name}</b>
                        <div style="font-size:12px; color:var(--gray)">${item.price} —Ä—É–±./—à—Ç.</div>
                    </div>
                    <div class="counter">
                        <button class="btn-qty" onclick="changeQty(${index}, -1)">-</button>
                        <span style="font-weight:bold; min-width:20px; text-align:center; margin: 0 10px">${item.qty}</span>
                        <button class="btn-qty" onclick="changeQty(${index}, 1)">+</button>
                    </div>
                </div>`).join('');
            html += `<div style="margin-top:20px; padding:15px; background:var(--secondary); border-radius:15px; text-align:right;">
                        <span style="color:var(--gray); font-size:14px;">–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</span>
                        <div style="font-size:20px; font-weight:800;">${totalSum} —Ä—É–±.</div>
                     </div>`;
            list.innerHTML = html;
        }

        function changeQty(index, delta) {
            const item = cart[index];
            if (delta > 0 && item.qty >= item.max) return;
            item.qty += delta;
            if (item.qty <= 0) cart.splice(index, 1);
            renderCart(); updateUI();
        }

        function checkout() {
            if (cart.length === 0) return;
            let totalSum = 0, hasPreorder = false;
            let orderDetails = "üõç **–î–ï–¢–ê–õ–ò –ó–ê–ö–ê–ó–ê:**\n";
            cart.forEach(item => {
                const itemSum = item.price * item.qty;
                totalSum += itemSum;
                if (item.type === '–†–∞—Å–∫—Ä–∞—Å–∫–∞') hasPreorder = true;
                orderDetails += `‚ñ™Ô∏è ${item.type} ${item.type === '–ú–∞—Ä–∫–µ—Ä' ? '‚Ññ' : '"'}${item.name}${item.type === '–ú–∞—Ä–∫–µ—Ä' ? '' : '"'}\n   ‚Äî ${item.qty} —à—Ç. x ${item.price} = ${itemSum} —Ä—É–±.\n`;
            });
            orderDetails += `\nüí∞ **–ò–¢–û–ì–û –ö –û–ü–õ–ê–¢–ï: ${totalSum} —Ä—É–±.**`;
            if (hasPreorder) {
                tg.showConfirm("–í –≤–∞—à–µ–º –∑–∞–∫–∞–∑–µ –µ—Å—Ç—å —Ä–∞—Å–∫—Ä–∞—Å–∫–∏. –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ: –æ–Ω–∏ –≤–µ–∑—É—Ç—Å—è –ü–û–î –ó–ê–ö–ê–ó. –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑?", (confirm) => {
                    if (confirm) sendOrder(orderDetails);
                });
            } else {
                sendOrder(orderDetails);
            }
        }

        function sendOrder(text) {
            tg.sendData(JSON.stringify({ details: text }));
            tg.close();
        }

        function tab(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.getElementById('btn-' + id).classList.add('active');
            if (id === 'shop') loadMarkers();
            if (id === 'cart') renderCart();
        }

        // --- –£–õ–£–ß–®–ï–ù–ù–´–ô –ü–†–û–°–ú–û–¢–† ---
        let currentVol, currentPage, maxPages, touchStartX, touchStartY;
        
        function startBook(v, m) {
            currentVol = v; maxPages = m; currentPage = 1;
            document.getElementById('viewer').style.display = 'block';
            updatePage();
        }

        function closeBook() { document.getElementById('viewer').style.display = 'none'; }

        function updatePage() {
            const img = document.getElementById('current-page');
            const counter = document.getElementById('page-counter');
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Ñ–æ—Ç–æ, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–µ–ª, —á—Ç–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –º–µ–Ω—è–µ—Ç—Å—è
            img.style.opacity = "0.3";
            
            const formats = ['.jpg', '.png', '.jpeg', '.JPG', '.PNG'];
            let fIndex = 0;

            function tryLoad() {
                img.src = `otveti/t${currentVol}/${currentPage}${formats[fIndex]}`;
            }

            img.onload = () => { img.style.opacity = "1"; };
            img.onerror = () => {
                fIndex++;
                if (fIndex < formats.length) tryLoad();
            };

            tryLoad();
            counter.innerText = `${currentPage} / ${maxPages}`;
        }

        function handleTouchStart(e) {
            touchStartX = e.touches[0].screenX;
            touchStartY = e.touches[0].screenY;
        }

        function handleTouchEnd(e) {
            let diffX = touchStartX - e.changedTouches[0].screenX;
            let diffY = touchStartY - e.changedTouches[0].screenY;

            // –ï—Å–ª–∏ –¥–≤–∏–∂–µ–Ω–∏–µ –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ –±–æ–ª—å—à–µ —á–µ–º –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ (–∑–∞—â–∏—Ç–∞ –æ—Ç —Å–ª—É—á–∞–π–Ω—ã—Ö —Å–≤–∞–π–ø–æ–≤ –≤–≤–µ—Ä—Ö-–≤–Ω–∏–∑)
            if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 40) {
                if (diffX > 0 && currentPage < maxPages) {
                    currentPage++;
                    updatePage();
                } else if (diffX < 0 && currentPage > 1) {
                    currentPage--;
                    updatePage();
                }
            }
        }

        function filterMarkers() {
            const q = document.getElementById('markerSearch').value.toLowerCase();
            renderMarkers(markersData.filter(m => m.number.includes(q)));
        }

        renderBooks();
    </script>
</body>
</html>
