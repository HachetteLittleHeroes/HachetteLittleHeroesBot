<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: var(--tg-theme-bg-color, #ffffff);
            --text: var(--tg-theme-text-color, #000000);
            --accent: var(--tg-theme-button-color, #007aff);
            --accent-text: var(--tg-theme-button-text-color, #ffffff);
            --secondary: var(--tg-theme-secondary-bg-color, #f2f2f7);
            --gray: #8e8e93;
            --card-bg: var(--tg-theme-secondary-bg-color, #f1f1f1);
        }

        body { 
            font-family: -apple-system, sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            margin: 0; 
            padding-bottom: 100px;
        }

        .header { padding: 20px 15px; font-size: 24px; font-weight: 800; display: flex; justify-content: space-between; align-items: center; }
        .page { display: none; padding: 0 15px; }
        .page.active { display: block; }

        /* –°–µ—Ç–∫–∞ –∫–Ω–∏–≥ */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .card { background: var(--card-bg); border-radius: 18px; overflow: hidden; border: 0.5px solid rgba(128,128,128,0.2); display: flex; flex-direction: column; }
        .card img { width: 100%; height: 160px; object-fit: cover; cursor: pointer; }
        .card-label { padding: 10px; font-weight: 600; font-size: 13px; text-align: center; flex-grow: 1; color: var(--text); }
        
        /* –ö–Ω–æ–ø–∫–∏ */
        .buy-btn { background: var(--accent); color: var(--accent-text); border: none; padding: 10px; font-weight: bold; cursor: pointer; width: 100%; }
        .buy-btn:disabled { background: var(--gray); opacity: 0.5; }

        /* –°–ø–∏—Å–æ–∫ –º–∞—Ä–∫–µ—Ä–æ–≤ */
        .row-item { 
            background: var(--card-bg); 
            padding: 15px; 
            border-radius: 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 8px; 
        }
        .marker-num { font-weight: 800; color: var(--text); font-size: 18px; }

        /* –ö–æ—Ä–∑–∏–Ω–∞ –∏ —Å—á–µ—Ç—á–∏–∫–∏ */
        .counter { display: flex; align-items: center; gap: 12px; }
        .btn-qty { 
            background: var(--accent); 
            color: var(--accent-text); 
            border: none; 
            width: 30px; height: 30px; 
            border-radius: 8px; 
            font-weight: bold; 
            font-size: 18px;
        }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .nav { position: fixed; bottom: 0; width: 100%; height: 75px; background: var(--bg); display: flex; border-top: 0.5px solid rgba(128,128,128,0.3); z-index: 999; }
        .nav-btn { flex: 1; border: none; background: none; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 11px; color: var(--gray); transition: 0.2s; }
        .nav-btn.active { color: var(--accent); }
        .nav-icon { font-size: 22px; margin-bottom: 4px; }
        .badge { position: absolute; top: 8px; right: 20%; background: #ff3b30; color: white; border-radius: 10px; padding: 2px 7px; font-size: 11px; font-weight: bold; }

        /* –ü—Ä–æ—Å–º–æ—Ç—Ä—â–∏–∫ */
        #viewer { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: var(--bg); z-index: 1000; }
        
        input { 
            width: 100%; padding: 12px; border-radius: 12px; border: none; 
            background: var(--secondary); color: var(--text); margin-bottom: 15px; box-sizing: border-box; 
        }
    </style>
</head>
<body>

    <div id="answers" class="page active">
        <div class="header">–ö–æ–ª–ª–µ–∫—Ü–∏–∏</div>
        <div class="grid" id="booksGrid"></div>
    </div>

    <div id="shop" class="page">
        <div class="header">–ú–∞—Ä–∫–µ—Ä—ã GuangNa</div>
        <input type="text" id="markerSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–æ–º–µ—Ä—É..." oninput="filterMarkers()">
        <div id="markersList"></div>
    </div>

    <div id="cart" class="page">
        <div class="header">–í–∞—à –∑–∞–∫–∞–∑</div>
        <div id="cartList"></div>
        <div id="cartTotal" style="padding: 20px 0; font-weight: bold; font-size: 18px; text-align: right;"></div>
        <button id="mainOrderBtn" class="buy-btn" style="border-radius: 15px; padding: 18px; display: none;" onclick="checkout()">
            –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑
        </button>
    </div>

    <div id="viewer">
        <div style="padding: 15px; display: flex; justify-content: space-between; align-items: center;">
            <button class="buy-btn" style="width: auto; border-radius: 8px;" onclick="closeBook()">–ù–∞–∑–∞–¥</button>
            <div id="page-counter" style="font-weight: bold;"></div>
        </div>
        <div style="height: 80vh; display: flex; align-items: center; justify-content: center;" ontouchstart="handleTouchStart(event)" ontouchend="handleTouchEnd(event)">
            <img src="" id="current-page" style="max-width: 95%; max-height: 100%; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
        </div>
    </div>

    <nav class="nav">
        <button id="btn-answers" class="nav-btn active" onclick="tab('answers')"><span class="nav-icon">üìö</span>–ö–Ω–∏–≥–∏</button>
        <button id="btn-shop" class="nav-btn" onclick="tab('shop')"><span class="nav-icon">üñçÔ∏è</span>–ú–∞—Ä–∫–µ—Ä—ã</button>
        <button id="btn-cart" class="nav-btn" onclick="tab('cart')">
            <span class="nav-icon">üõí</span>–ö–æ—Ä–∑–∏–Ω–∞
            <span id="cartBadge" class="badge" style="display:none">0</span>
        </button>
    </nav>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        let markersData = [];
        let cart = [];
        const availableVolumes = [1, 2, 9]; // –¢–æ–ª—å–∫–æ —ç—Ç–∏ —Ç–æ–º–∞ –º–æ–∂–Ω–æ –∫—É–ø–∏—Ç—å

        const allBooks = [
            {id: 1, name: "Classiques tome 11", pages: 26},
            {id: 2, name: "Classiques tome 3", pages: 26},
            {id: 3, name: "Vitraux tome 2", pages: 26},
            {id: 9, name: "Romantasy", pages: 10},
            {id: 10, name: "Princesses tome 1", pages: 26}
        ];

        function renderBooks() {
            const grid = document.getElementById('booksGrid');
            grid.innerHTML = allBooks.map(b => `
                <div class="card">
                    <img src="img/t${b.id}.png" onclick="startBook(${b.id}, ${b.pages})">
                    <div class="card-label">${b.name}</div>
                    ${availableVolumes.includes(b.id) 
                        ? `<button class="buy-btn" onclick="addToCart('–¢–æ–º', '${b.name}', ${b.id})">–í –∫–æ—Ä–∑–∏–Ω—É</button>`
                        : `<div style="text-align:center; font-size:11px; padding:10px; color:var(--gray)">–û–∂–∏–¥–∞–µ—Ç—Å—è</div>`}
                </div>
            `).join('');
        }

        async function loadMarkers() {
            const csvUrl = 'https://docs.google.com/spreadsheets/d/1Yrsif-aQwbuT6fLPnP4MsM22UuwuUWz5FYegELPxzFU/gviz/tq?tqx=out:csv';
            try {
                const response = await fetch(csvUrl);
                const text = await response.text();
                const rows = text.split('\n').map(row => row.split(',').map(cell => cell.replace(/"/g, '').trim()));
                let temp = [];
                rows.forEach(row => {
                    for (let i = 0; i < row.length; i++) {
                        let num = row[i];
                        if (num && !isNaN(num) && parseInt(num) > 10) {
                            let count = row[i+1] || row[i+2] || "0";
                            temp.push({ number: num, count: parseInt(count) });
                            i++;
                        }
                    }
                });
                markersData = temp.filter((v, i, a) => a.findIndex(t => (t.number === v.number)) === i);
                renderMarkers(markersData);
            } catch (e) { console.error(e); }
        }

        function renderMarkers(data) {
            const list = document.getElementById('markersList');
            data.sort((a,b) => a.number - b.number);
            list.innerHTML = data.map(m => `
                <div class="row-item">
                    <span class="marker-num">‚Ññ ${m.number}</span>
                    <div class="counter">
                        ${m.count > 0 
                            ? `<button class="btn-qty" onclick="addToCart('–ú–∞—Ä–∫–µ—Ä', '${m.number}', ${m.number})">+</button>` 
                            : '<span style="color:#ff3b30; font-size:12px; font-weight:bold;">–ó–∞–∫–æ–Ω—á–∏–ª—Å—è</span>'}
                    </div>
                </div>
            `).join('');
        }

        function addToCart(type, name, id) {
            const key = type + '-' + id;
            const existing = cart.find(i => i.key === key);
            if (existing) {
                existing.qty++;
            } else {
                cart.push({ key, type, name, id, qty: 1 });
            }
            updateUI();
            tg.HapticFeedback.impactOccurred('light');
        }

        function updateUI() {
            const totalItems = cart.reduce((sum, i) => sum + i.qty, 0);
            const badge = document.getElementById('cartBadge');
            badge.innerText = totalItems;
            badge.style.display = totalItems > 0 ? 'block' : 'none';
            document.getElementById('mainOrderBtn').style.display = totalItems > 0 ? 'block' : 'none';
        }

        function renderCart() {
            const list = document.getElementById('cartList');
            if (cart.length === 0) {
                list.innerHTML = '<div style="text-align:center; padding:50px; color:var(--gray)">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>';
                return;
            }
            list.innerHTML = cart.map((item, index) => `
                <div class="row-item">
                    <div>
                        <div style="font-size:12px; color:var(--gray)">${item.type}</div>
                        <div style="font-weight:bold; color:var(--text)">${item.type === '–ú–∞—Ä–∫–µ—Ä' ? '‚Ññ ' : ''}${item.name}</div>
                    </div>
                    <div class="counter">
                        <button class="btn-qty" onclick="changeQty(${index}, -1)">-</button>
                        <span style="min-width:20px; text-align:center; font-weight:bold; color:var(--text)">${item.qty}</span>
                        <button class="btn-qty" onclick="changeQty(${index}, 1)">+</button>
                    </div>
                </div>
            `).join('');
        }

        function changeQty(index, delta) {
            cart[index].qty += delta;
            if (cart[index].qty <= 0) cart.splice(index, 1);
            renderCart();
            updateUI();
        }

        function checkout() {
            if (cart.length === 0) return;
            tg.showConfirm("–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É?", (ok) => {
                if (ok) {
                    const orderText = cart.map(i => `${i.type} ${i.name} ‚Äî ${i.qty} —à—Ç.`).join('\n');
                    const data = {
                        action: "new_order",
                        items: orderText,
                        total_count: cart.reduce((sum, i) => sum + i.qty, 0)
                    };
                    tg.sendData(JSON.stringify(data));
                }
            });
        }

        function tab(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.getElementById('btn-' + id).classList.add('active');
            if (id === 'shop' && markersData.length === 0) loadMarkers();
            if (id === 'cart') renderCart();
            tg.HapticFeedback.selectionChanged();
        }

        // --- –õ–æ–≥–∏–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä—â–∏–∫–∞ ---
        let currentVol, currentPage, maxPages, touchStartX;
        function startBook(v, m) { currentVol=v; maxPages=m; currentPage=1; document.getElementById('viewer').style.display='block'; updatePage(); }
        function closeBook() { document.getElementById('viewer').style.display='none'; }
        function updatePage() {
            const img = document.getElementById('current-page');
            img.src = `otveti/t${currentVol}/${currentPage}.jpg`;
            document.getElementById('page-counter').innerText = `${currentPage} / ${maxPages}`;
        }
        function handleTouchStart(e) { touchStartX = e.touches[0].screenX; }
        function handleTouchEnd(e) {
            let diff = touchStartX - e.changedTouches[0].screenX;
            if (diff > 50 && currentPage < maxPages) { currentPage++; updatePage(); }
            if (diff < -50 && currentPage > 1) { currentPage--; updatePage(); }
        }

        function filterMarkers() {
            const q = document.getElementById('markerSearch').value;
            renderMarkers(markersData.filter(m => m.number.includes(q)));
        }

        renderBooks();
    </script>
</body>
</html>
